/*! 
 Build based on gin-vue-admin 
 Time : 1705585352000 */
import{a as e,r as a,O as t,W as n,o as s,c as l,d as r,b as o,q as i,w as c,g as u,t as d,h as m,e as p,n as f,U as g,k as y,aI as b,l as w,E as h,J as v}from"./index-0efc4537.js";import{E as k}from"./drawer-25d6170f.js";import"./overlay-73152bda.js";import{a as _,E as j}from"./form-150c0e00.js";import{E as C}from"./upload-276f24ce.js";import"./progress-6c49b316.js";/* empty css             *//* empty css                  */import{E as x}from"./pagination-956e76f8.js";/* empty css              */import"./tag-c095386a.js";import"./select-59043028.js";import"./scrollbar-ab08f6f1.js";/* empty css               */import{E as A,a as N}from"./table-column-ce6481a3.js";import"./checkbox-aefa5e2d.js";/* empty css                *//* empty css               */import{E as D,a as I,b as E}from"./dropdown-item-9e4a6efb.js";import{b as R,c as V,e as T,p as U,r as z,d as P,a as L}from"./sieve-07c29ea9.js";import{W as M}from"./warningBar-5328b630.js";import{f as B}from"./date-8358c12f.js";import{E as F}from"./index-70d4cce8.js";import"./isUndefined-d281c39a.js";import"./castArray-f160d2a3.js";import"./_baseClone-9af99e91.js";import"./_Uint8Array-4999d338.js";import"./_initCloneObject-b273bb42.js";import"./cloneDeep-585751f1.js";import"./isEqual-aa7e7ef2.js";import"./hasIn-deea815f.js";import"./index-c5b62cef.js";import"./strings-a95e1d29.js";import"./debounce-994b39f4.js";import"./index-4b62258d.js";import"./dropdown-b49e545a.js";import"./refs-04938f0e.js";const S={class:"authority"},q={class:"gva-table-box"},O={class:"gva-btn-list"},W={class:"button-section"},J={class:"search-section flex space-x-4 -ml-2"},$={class:"text-ellipsis"},G={key:0},H={key:1},K={key:0},Z={key:1},Q={class:"button-group"},X={class:"text-sm text-orange-300 mt-2"},Y={__name:"sieve_task",setup(Y){const ee=()=>{ae.value=!1},ae=e(!1),te=e(1),ne=e(0),se=e(10),le=e([]),re=e(""),oe=e(""),ie=e(!1),ce=e=>{te.value=e,pe()},ue=e=>{se.value=e,pe()},de=async()=>{oe.value=re.value,await pe()},me=()=>{re.value="",oe.value="",pe()},pe=async(e,a)=>{const t=await R({page:te.value,pageSize:se.value,taskName:oe.value,sort:e,order:a});0===t.code&&(le.value=[],setTimeout((()=>{t.data.list.forEach((e=>{e.createdAt=e.createdAt?B(e.createdAt,"yyyy-MM-dd hh:mm:ss"):"",e.updatedAt=e.updatedAt?B(e.updatedAt,"yyyy-MM-dd hh:mm:ss"):""})),le.value=t.data.list,De(t.data.list)?Ae():Ne()}),100),ne.value=t.data.total,te.value=t.data.page,se.value=t.data.pageSize)};pe();const fe=({prop:e,order:a})=>{a?(a="ascending"===a?"asc":"desc",e=e?e.replace(/[\w]([A-Z])/g,(function(e){return e[0]+"_"+e[1]})).toLowerCase():null):(a=null,e=null),pe(e,a)};const ge=e=>{switch(e){case"Init":return"初始化";case"Pending":return"等待";case"Success":return"已成功";case"Failed":return"失败";case"Running":return"运行中";case"Pause":return"已暂停";default:return""}},ye=e=>{switch(e){case"Init":case"Running":return"info";case"Pending":return"warning";case"Success":return"success";case"Failed":case"Pause":return"danger";default:return""}},be=e=>{switch(e){case"Init":return"el-icon-help-filled";case"Pending":return"el-icon-clock";case"Success":return"CircleCheck";case"Failed":return"el-icon-circle-close";case"Running":return"el-icon-loading";case"Pause":return"VideoPlay";default:return""}},we=e(null),he=e([]),ve=(e,a)=>{he.value=a,a.length>0?ke.file=a[0].raw:ke.file=null},ke=a({taskName:"",concurrency:0,file:null,immediate:!0}),_e={taskName:[{required:!0,message:"请输入任务名称",trigger:"blur"}],file:[{required:!0,message:"请上传文件",trigger:"change"}],concurrency:[{required:!0,message:"请输入并发数",trigger:"blur"},{type:"number",message:"并发数必须为数字值",trigger:"blur"}]},je=async()=>{if(!(await we.value.validate()))return;const e=new FormData;e.append("taskName",ke.taskName),e.append("concurrency",ke.concurrency),e.append("immediate",ke.immediate),ke.file&&e.append("file",ke.file,ke.file.name);try{const a=await T(e);a&&0===a.code&&(y.success("提交成功！"),Ee.value.currentConcurrency=Ee.value.currentConcurrency-ke.concurrency,setTimeout((()=>{pe()}),500),ee())}catch(a){y.error(a.message)}},Ce=()=>{we.value&&we.value.resetFields()};let xe=null;const Ae=()=>{xe||(xe=setInterval((()=>{pe()}),5e3))},Ne=()=>{xe&&(clearInterval(xe),xe=null)},De=e=>e.some((e=>"Running"===e.status));t((()=>{Ae(),window.addEventListener("beforeunload",(()=>{Ne()}))}));const Ie=async(e,a,t,n=3e3)=>{try{y.info("准备下载，请稍候...");const s=await e(a.ID);if(s&&s.data){console.log("开始下载 ".concat(t),s);const e=new Blob([s.data],{type:"text/plain"});setTimeout((()=>{const a=window.URL.createObjectURL(e),n=document.createElement("a");n.href=a,n.setAttribute("download",t),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a),y.success("下载成功")}),n)}else y.error("下载 ".concat(t," 失败：没有数据返回"))}catch(s){y.error("下载出错"),console.error("下载出错",s)}},Ee=e({concurrencyLimit:0,currentConcurrency:0}),Re=async()=>{ie.value=!0;const e=await b();Ee.value=e.data,setTimeout((()=>{ie.value=!1}),1e3)},Ve=e=>{const{columns:a,data:t}=e,n=[];return a.forEach(((e,a)=>{if(0!==a)if(["nonDisabledAccounts","disabledAccounts","totalNumber"].includes(e.property)){const s=t.map((a=>Number(a[e.property])));n[a]=s.reduce(((e,a)=>{const t=Number(a);return isNaN(t)?e:e+a}),0)}else n[a]="";else n[a]="合计"})),n};return(e,a)=>{const t=F,b=w,R=h,T=A,B=D,Y=I,oe=E,he=N,xe=x,Ae=_,De=n("Refresh"),Te=v,Ue=n("Warning"),ze=C,Pe=j,Le=k;return s(),l("div",S,[r(M,{title:"注：批量筛号"}),o("div",q,[o("div",O,[o("div",W,[r(t,{class:"box-item",effect:"dark",content:"暂未开发，敬请期待",placement:"top-start"}),r(t,{class:"box-item",effect:"dark",content:"暂未开发，敬请期待",placement:"top-start"}),r(t,{class:"box-item",effect:"dark",content:"暂未开发，敬请期待",placement:"top-start"})]),o("div",J,[r(b,{modelValue:re.value,"onUpdate:modelValue":a[0]||(a[0]=e=>re.value=e),placeholder:"请输入任务名称",clearable:"",style:{width:"200px"},onClear:me,onKeyup:i(de,["enter","native"])},null,8,["modelValue"]),r(R,{type:"primary",icon:"Search",onClick:de},{default:c((()=>[u("搜索")])),_:1})]),r(R,{icon:"refresh",onClick:pe},{default:c((()=>[u("刷新")])),_:1}),r(R,{type:"primary",icon:"CirclePlus",class:"ml-auto mr-4",onClick:a[1]||(a[1]=()=>{ae.value=!0,Re()})},{default:c((()=>[u("新建任务")])),_:1})]),r(he,{data:le.value,"tree-props":{children:"children",hasChildren:"hasChildren"},"row-key":"authorityId",style:{width:"100%"},"show-summary":!0,"summary-method":Ve,onSortChange:fe},{default:c((()=>[r(T,{label:"ID","min-width":"180",prop:"ID"}),r(T,{align:"left",label:"任务名称","min-width":"180",prop:"taskName"}),r(T,{align:"left",label:"文件名称","min-width":"180",prop:"file_name"},{default:c((e=>[r(t,{class:"item",effect:"dark",content:e.row.file_name,placement:"top"},{default:c((()=>[o("div",$,d(e.row.file_name.length>10?e.row.file_name.substr(0,10)+"...":e.row.file_name),1)])),_:2},1032,["content"])])),_:1}),r(T,{align:"left",label:"任务状态","min-width":"180"},{default:c((({row:e})=>[r(R,{type:ye(e.status),size:"small","loading-icon":"Eleme",loading:"Running"==e.status,icon:be(e.status),plain:""},{default:c((()=>[u(d(ge(e.status)),1)])),_:2},1032,["type","loading","icon"])])),_:1}),r(T,{align:"left",label:"正常账号数量","min-width":"180",prop:"nonDisabledAccounts"},{default:c((({row:e})=>[u(d(e.nonDisabledAccounts)+" ",1),e.nonDisabledAccounts+e.disabledAccounts>0?(s(),l("span",G," ("+d(Math.floor(Number(e.nonDisabledAccounts)/Number(e.totalNumber)*100))+"%) ",1)):(s(),l("span",H," (0%) "))])),_:1}),r(T,{align:"left",label:"禁用账号数量","min-width":"180",prop:"disabledAccounts"},{default:c((({row:e})=>[u(d(e.disabledAccounts)+" ",1),e.totalNumber>0?(s(),l("span",K," ("+d(Math.floor((e.disabledAccounts/e.totalNumber*100).toFixed(2),100))+"%) ",1)):(s(),l("span",Z,"0%"))])),_:1}),r(T,{align:"left",label:"总数","min-width":"180",prop:"totalNumber"},{default:c((({row:e})=>[u(d(e.totalNumber),1)])),_:1}),r(T,{align:"left",label:"并发数","min-width":"180",prop:"concurrency"}),r(T,{align:"left",label:"提交时间","min-width":"180",prop:"createdAt",sortable:"custom"}),r(T,{align:"left",label:"更新时间","min-width":"180",prop:"updatedAt",sortable:"custom"}),r(T,{align:"left",label:"操作",width:"250",fixed:"right"},{default:c((a=>[o("div",Q,[r(R,{icon:"Files",type:"primary",link:"",onClick:t=>e.$router.push({name:"sieve_number",params:{id:a.row.ID}})},{default:c((()=>[u("详情")])),_:2},1032,["onClick"]),r(R,{icon:"delete",type:"primary",link:"",onClick:e=>{return t=a.row,void g.confirm("此操作将永久删除该任务及相关账号, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{0===(await V({ID:t.ID})).code&&(y({type:"success",message:"任务删除成功 !"}),1===le.value.length&&te.value>1&&te.value--,pe(),le.value.some((e=>"Running"===e.status))||Ne())})).catch((()=>{y({type:"info",message:"已取消删除"})}));var t}},{default:c((()=>[u("删除")])),_:2},1032,["onClick"]),r(oe,{trigger:"click",class:"el-button-like"},{dropdown:c((()=>[r(Y,null,{default:c((()=>["Pause"===a.row.status?(s(),m(B,{key:0,onClick:e=>{return t=a.row,void g.confirm('您确定要恢复"'.concat(t.taskName,'"吗'),"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{const e=await z(t.ID);console.log("测试",e),0===e.code?(y({type:"success",message:'任务 "'.concat(t.taskName,'" 恢复成功!')}),setTimeout((()=>{pe()}),3e3)):y({type:"error",message:e.data.message||"恢复任务失败"})}catch(e){e&&e.response&&y({type:"error",message:e.response.data.message||"请求失败"})}})).catch((()=>{}));var t}},{default:c((()=>[u("恢复")])),_:2},1032,["onClick"])):p("",!0),"Running"===a.row.status?(s(),m(B,{key:1,onClick:e=>{return t=a.row,void g.confirm('您确定要暂停"'.concat(t.taskName,'"吗'),"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{const e=await U(t.ID);0===e.code?(y({type:"success",message:"暂停成功"}),setTimeout((()=>{pe()}),500)):y({type:"error",message:e.data.message||"暂停任务失败"}),pe()})).catch((()=>{y({type:"info",message:"操作已取消"})}));var t}},{default:c((()=>[u("暂停")])),_:2},1032,["onClick"])):p("",!0),a.row.nonDisabledAccounts>0&&a.row.DisabledAccounts>0?(s(),m(B,{key:2},{default:c((()=>[u("什么都没有")])),_:1})):p("",!0),a.row.nonDisabledAccounts>1?(s(),m(B,{key:3,onClick:e=>(async e=>{await Ie(L,e,"正常账号.txt")})(a.row)},{default:c((()=>[u("下载存活账号")])),_:2},1032,["onClick"])):p("",!0),a.row.disabledAccounts>1?(s(),m(B,{key:4,onClick:e=>(async e=>{await Ie(P,e,"禁用账号.txt")})(a.row)},{default:c((()=>[u("下载禁用账号")])),_:2},1032,["onClick"])):p("",!0)])),_:2},1024)])),default:c((()=>[r(R,{class:"button-with-icon-right ml-3",type:"primary",link:"",icon:"More"},{default:c((()=>[u("更多操作")])),_:1})])),_:2},1024)])])),_:1})])),_:1},8,["data"]),r(xe,{"current-page":te.value,"page-size":se.value,"page-sizes":[10,30,50,100],total:ne.value,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:ce,onSizeChange:ue},null,8,["current-page","page-size","total"])]),r(Le,{modelValue:ae.value,"onUpdate:modelValue":a[5]||(a[5]=e=>ae.value=e),title:"新建任务","before-close":ee},{default:c((()=>[r(Pe,{ref_key:"formRef",ref:we,model:ke,rules:_e,"label-width":"120px"},{default:c((()=>[r(Ae,{label:"任务名称",prop:"taskName"},{default:c((()=>[r(b,{modelValue:ke.taskName,"onUpdate:modelValue":a[2]||(a[2]=e=>ke.taskName=e),autocomplete:"off",placeholder:"请输入任务名称"},null,8,["modelValue"])])),_:1}),r(Ae,{label:"并发数",prop:"concurrency"},{default:c((()=>[r(b,{modelValue:ke.concurrency,"onUpdate:modelValue":a[3]||(a[3]=e=>ke.concurrency=e),modelModifiers:{number:!0},type:"number",placeholder:"并发数",min:1,max:1e3,style:{width:"100%"}},null,8,["modelValue"]),o("span",X,"当前可用并发数"+d(Ee.value.concurrencyLimit-Ee.value.currentConcurrency),1),r(Te,{class:f(["mt-2 cursor-pointer",{rotate:ie.value}]),style:{"margin-left":"4px"},size:12,onClick:a[4]||(a[4]=e=>Re())},{default:c((()=>[r(De)])),_:1},8,["class"])])),_:1}),r(Ae,{label:"上传文件",prop:"file"},{default:c((()=>[r(ze,{ref:"uploadRef",class:"upload-demo w-full","on-change":ve,"before-upload":()=>!1,"auto-upload":!1},{trigger:c((()=>[r(R,null,{default:c((()=>[u("选择文件")])),_:1})])),default:c((()=>[r(t,{effect:"dark",content:"为了最佳优化，请将手机号以.txt格式上传，并确保每行只包含一个手机号",placement:"top"},{default:c((()=>[r(Te,{style:{"margin-left":"4px"},size:12},{default:c((()=>[r(Ue)])),_:1})])),_:1})])),_:1},512)])),_:1}),r(Ae,null,{default:c((()=>[r(R,{type:"primary",icon:"Position",class:"w-[7rem] rounded",onClick:je},{default:c((()=>[u("提交")])),_:1}),r(R,{icon:"RefreshLeft",class:"w-[7rem] rounded",onClick:Ce},{default:c((()=>[u("重置")])),_:1})])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}};export{Y as default};
